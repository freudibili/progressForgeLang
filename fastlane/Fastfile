default_platform(:ios)

before_all do
  ENV["SLACK_URL"] = "https://hooks.slack.com/services/..." # Optional Slack webhook
  setup_ci if is_ci
end

# Shared helper methods
def ensure_git_status_clean
  unless `git status`.include?("nothing to commit")
    UI.user_error!("Git status is not clean. Please commit or stash your changes.")
  end
end

def get_version_number
  require 'json'
  json = JSON.parse(File.read('../app.json'))
  json['expo']['version']
end

def increment_version_number
  require 'json'
  app_json = JSON.parse(File.read('../app.json'))
  current_version = app_json['expo']['version']
  major, minor, patch = current_version.split('.').map(&:to_i)
  new_version = "#{major}.#{minor}.#{patch + 1}"
  app_json['expo']['version'] = new_version
  File.write('../app.json', JSON.pretty_generate(app_json))
  new_version
end

def get_build_number
  Time.now.strftime("%Y%m%d%H%M")
end

def increment_build_number
  require 'json'
  app_json = JSON.parse(File.read('../app.json'))
  current_build = app_json.dig('expo', 'android', 'versionCode') || 1
  
  # Make sure we're getting at least 1 higher than the current version
  new_build = current_build + 1
  
  # Update the app.json file
  app_json['expo']['android']['versionCode'] = new_build
  File.write('../app.json', JSON.pretty_generate(app_json))
  
  puts "Incremented version code to #{new_build}"
  new_build
end

platform :ios do
  desc "Deploy iOS to App Store"
  lane :deploy do
    ensure_git_status_clean

    new_version = increment_version_number
    new_build = get_build_number

    build_ios_app(
      scheme: "ProgressForgeLang",
      export_method: "app-store",
      configuration: "Release",
      clean: true,
      output_directory: "build",
      output_name: "ProgressForgeLang.ipa"
    )

    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: true,
      force: true
    )

    sh "git add ../app.json"
    sh "git commit -m 'Bump version to #{new_version} (build #{new_build})'"
  end

  desc "Deploy iOS to TestFlight"
  lane :beta do
    ensure_git_status_clean

    new_version = increment_version_number
    new_build = get_build_number

    build_ios_app(
      scheme: "ProgressForgeLang",
      export_method: "app-store",
      configuration: "Release",
      clean: true,
      output_directory: "build",
      output_name: "ProgressForgeLang.ipa"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      changelog: "New beta version #{new_version} (build #{new_build})"
    )

    sh "git add ../app.json"
    sh "git commit -m 'Bump version to #{new_version} (build #{new_build})'"
  end
end

platform :android do
  desc "Deploy Android to Play Store"
  lane :deploy do
    ensure_git_status_clean

    new_version = increment_version_number
    new_build = increment_build_number
    
    # Print version information for debugging
    UI.important("Version number from app.json: #{new_version}")
    UI.important("Build number after increment: #{new_build}")
    UI.important("Version code type: #{new_build.class}")
    
    # Ensure version code is an integer, not a string
    version_code = new_build.to_i
    UI.important("Final version code (integer): #{version_code}")

    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android",
      flags: "--stacktrace --info",
      properties: {
        "android.injected.signing.store.file" => ENV["ANDROID_KEYSTORE_FILE"],
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"],
        "android.injected.version.code" => new_build.to_s,
        "org.gradle.logging.level" => "info"
      }
    )

    upload_to_play_store(
      track: 'production',
      release_status: 'completed',
      metadata_path: "fastlane/metadata/android",
      json_key: "fastlane/google-play-credentials.json",
      package_name: "com.progressforgelang.app"
    )

    sh "git add ../app.json"
    sh "git commit -m 'Bump version to #{new_version} (build #{new_build})'"
  end

  desc "Deploy Android to internal testing"
  lane :beta do
    ensure_git_status_clean

    new_version = increment_version_number
    new_build = increment_build_number
    
    # Print version information for debugging
    UI.important("Version number from app.json: #{new_version}")
    UI.important("Build number after increment: #{new_build}")
    UI.important("Version code type: #{new_build.class}")
    
    # Ensure version code is an integer, not a string
    version_code = new_build.to_i
    UI.important("Final version code (integer): #{version_code}")
    
    # Print diagnostics about the environment
    sh "echo 'Android SDK location: $ANDROID_SDK_ROOT'"
    sh "echo 'Java version: openjdk version'"
    sh "echo 'Keystore path from env: $ANDROID_KEYSTORE_FILE'"
    
    # Explicitly check and log keystore info
    keystore_path = ENV["ANDROID_KEYSTORE_FILE"] || ""
    UI.important("Keystore path from env: '#{keystore_path}'")
    UI.important("Env variables: #{ENV.keys.select { |k| k.include?('KEYSTORE') || k.include?('ANDROID') }.join(', ')}")
    
    # Convert to absolute path
    if keystore_path.empty? || !File.exist?(keystore_path)
      UI.error("âŒ Keystore file not found at: #{keystore_path}")
      # Try the relative path as a fallback
      relative_path = File.join("..", "android", "app", "keystore.jks")
      UI.important("Trying relative path: #{relative_path}")
      if File.exist?(relative_path)
        UI.success("âœ… Keystore found at relative path: #{relative_path}")
        keystore_path = File.absolute_path(relative_path)
        UI.success("Absolute path: #{keystore_path}")
      else
        UI.error("âŒ Keystore also not found at relative path")
        # Set a default as last resort
        keystore_path = File.absolute_path(File.join("..", "android", "app", "keystore.jks"))
      end
    else
      # Make sure we have an absolute path
      keystore_path = File.absolute_path(keystore_path)
      UI.success("âœ… Using absolute keystore path: #{keystore_path}")
    end
    
    # Double check the file exists
    if File.exist?(keystore_path)
      UI.success("Final check: âœ… Keystore exists at: #{keystore_path}")
      sh "ls -la #{keystore_path}"
    else
      UI.error("Final check: âŒ Keystore not found at: #{keystore_path}")
      UI.error("Will try to continue anyway...")
    end
    
    # Pass explicit environment variables to gradle
    gradle_env = {
      "ANDROID_KEYSTORE_FILE" => keystore_path,
      "ANDROID_KEYSTORE_PASSWORD" => ENV["ANDROID_KEYSTORE_PASSWORD"],
      "ANDROID_KEY_ALIAS" => ENV["ANDROID_KEY_ALIAS"],
      "ANDROID_KEY_PASSWORD" => ENV["ANDROID_KEY_PASSWORD"]
    }
    
    UI.important("Building with keystore at: #{keystore_path}")
    
    # Use gradle action for more reliable environment variable passing
    gradle(
      task: "bundleRelease",
      project_dir: "android",
      properties: {
        # Use absolute path for keystore
        "android.injected.signing.store.file" => File.absolute_path(keystore_path),
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"],
        # Ensure version code is an integer and convert to string for Gradle
        "android.injected.version.code" => version_code.to_s,
        "android.injected.version.name" => get_version_number
      },
      flags: "--stacktrace --info",
      print_command: true,
      print_command_output: true
    )

    upload_to_play_store(
      track: 'internal',
      release_status: 'draft',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true,
      json_key: "fastlane/google-play-credentials.json",
      package_name: "com.progressforgelang.app"
    )

    # Commit the version bump to app.json
    sh("git add ../app.json")
    sh("git commit -m 'Bump version to #{new_version} (build #{new_build})'")
    UI.success("Successfully bumped version to #{new_version} (build #{new_build}) and committed changes")
  end
end

error do |lane, exception|
  slack(
    message: "ðŸš¨ Error in lane #{lane}: #{exception.message}",
    success: false
  )
end
